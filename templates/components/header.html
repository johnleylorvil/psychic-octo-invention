{% load static %}

<style>
    /* Navigation principale */
    .main-nav ul { display: flex; list-style: none; margin: 0; padding: 0; align-items: center; }
    .main-nav a, .account-menu .dropdown-menu a { 
        display: flex; 
        align-items: center;
        gap: 8px; /* Espace entre l'icône et le texte */
        padding: 30px 18px; 
        text-decoration: none; 
        color: var(--text-dark, #333); 
        font-weight: 500;
        transition: color 0.2s ease-in-out;
    }
    .main-nav a:hover, .account-menu a:hover { color: var(--primary-orange, #E67E22); }

    /* Implémentation du menu déroulant (Générique) */
    .has-dropdown .dropdown-menu {
        display: none; /* Caché par défaut */
        position: absolute;
        top: 100%;
        /* Aligner à droite pour le menu utilisateur */
        right: 0; 
        left: auto;
        background: white;
        box-shadow: var(--shadow-medium, 0 8px 24px rgba(0, 0, 0, 0.1));
        list-style: none;
        padding: 10px 0;
        border-radius: 8px;
        min-width: 220px;
        z-index: 1001;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    /* S'assurer que le dropdown de la nav principale reste aligné à gauche */
    .main-nav .has-dropdown .dropdown-menu {
        left: 0;
        right: auto;
    }
    .has-dropdown:hover .dropdown-menu {
        display: block; /* Affiché au survol */
        opacity: 1;
        transform: translateY(0);
    }
    .dropdown-menu a {
        padding: 12px 20px !important; /* !important pour surcharger le padding de base */
        width: 100%;
        box-sizing: border-box;
        color: var(--text-subtle, #555);
    }

    /* Style du compteur de panier */
    .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: var(--secondary-orange, #D35400);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .cart-count.animate { animation: bounceCart 0.5s ease; }
    @keyframes bounceCart {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }
</style>

<div class="top-bar" style="background-color: var(--primary-orange, #E67E22); color: white; padding: 8px 20px; font-size: 14px; text-align: center;">
    <div class="top-bar-container" style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
        <span><i class="fas fa-phone-alt" style="margin-right: 5px;"></i>Contact: +509 1234 5678</span>
        <span>Livraison Rapide sur Port-au-Prince!</span>
    </div>
</div>

<header class="main-header" style="background-color: #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 1000;">
    <div class="header-container" style=" display: flex; justify-content: center; align-items: center; width: 100%; padding: 0 20px; display: flex; align-items: center; height: 80px; justify-content: space-between;">
        
        <div class="header-logo">
            <a href="{% url 'home' %}" style="font-family: 'Lora', serif; font-size: 26px; font-weight: 700; color: var(--secondary-orange, #D35400); text-decoration: none;">Afèpanou</a>
        </div>

        <nav class="main-nav">
            <ul>
                <li><a href="{% url 'store' %}?category=necessite"><i class="fas fa-shopping-basket"></i> Essentiels</a></li>
                <li><a href="{% url 'store' %}?category=patriotique"><i class="fas fa-flag"></i> Patriotique</a></li>
                <li class="has-dropdown" style="position: relative;">
                    <a href="{% url 'store' %}?category=locaux"><i class="fas fa-store"></i> Local <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 5px;"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="{% url 'store' %}?category=artisanat">Artisanat</a></li>
                        <li><a href="{% url 'store' %}?category=industrie">Petite Industrie</a></li>
                        <li><a href="{% url 'store' %}?category=agricole">Production Agricole</a></li>
                    </ul>
                </li>
                <li><a href="{% url 'store' %}?category=services"><i class="fas fa-concierge-bell"></i> Services</a></li>
            </ul>
        </nav>

        <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
            <div class="header-center">
                <form action="{% url 'store' %}" method="get" class="search-bar" style="display: flex; align-items: center; background: #f5f5f5; border-radius: 20px; padding: 5px 15px;">
                    <i class="fas fa-search" style="color: #888;"></i>
                    <input type="text" name="q" placeholder="Rechercher..." value="{{ search_query|default:'' }}" style="border: none; background: transparent; outline: none; padding: 5px 10px; width: 150px;">
                </form>
            </div>

            <div class="header-actions" style="display: flex; align-items: center; gap: 20px;">
                
                <div class="account-menu has-dropdown" style="position: relative;">
                    
                    {% if user.is_authenticated %}
                        <a href="{% url 'dashboard' %}" class="account-btn" style="color: #333; font-size: 20px;" title="Mon compte">
                            <i class="fas fa-user-check"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Mon Tableau de Bord</a></li>
                            <li><a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
                        </ul>

                    {% else %}
                        <a href="{% url 'login' %}" class="account-btn" style="color: #333; font-size: 20px;" title="Se connecter">
                            <i class="fas fa-user"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="{% url 'login' %}"><i class="fas fa-sign-in-alt"></i> Se Connecter</a></li>
                            <li><a href="{% url 'signup' %}"><i class="fas fa-user-plus"></i> S'inscrire</a></li>
                        </ul>
                    {% endif %}

                </div>
                <a href="{% url 'cart' %}" class="cart-icon" style="color: #333; font-size: 20px; text-decoration: none; position: relative;">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-item-count" class="cart-count" {% if cart_item_count > 0 %}style="display: flex;"{% else %}style="display: none;"{% endif %}>
                        {{ cart_item_count|default:0 }}
                    </span>
                </a>
            </div>
        </div>
        
        <button class="burger-menu" aria-label="Ouvrir le menu" style="display: none;">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
</header>

<script>
// Fonction globale pour mettre à jour l'icône du panier
function updateCartIcon(count) {
    const cartIcon = document.getElementById('cart-item-count');
    if (cartIcon) {
        cartIcon.textContent = count;
        
        if (count > 0) {
            cartIcon.style.display = 'flex';
            // Animation bounce quand on ajoute un item
            cartIcon.classList.add('animate');
            setTimeout(() => {
                cartIcon.classList.remove('animate');
            }, 500);
        } else {
            cartIcon.style.display = 'none';
        }
    }
}

// Fonction pour obtenir le cookie CSRF (utilisée dans les autres pages)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialisation du compteur au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Si on est sur une page avec un formulaire d'ajout au panier
    const addToCartForms = document.querySelectorAll('.add-to-cart-form');
    
    addToCartForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = this.querySelector('.add-to-cart-btn').dataset.productId;
            const quantity = this.querySelector('#quantity') ? this.querySelector('#quantity').value : 1;
            const csrftoken = getCookie('csrftoken');
            
            fetch("{% url 'add_to_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: parseInt(quantity)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateCartIcon(data.cart_item_count);
                    
                    // Notification de succès
                    showNotification('Produit ajouté au panier !', 'success');
                } else {
                    showNotification('Erreur: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('Erreur lors de l\'ajout au panier', 'error');
            });
        });
    });
});

// Fonction pour afficher des notifications
function showNotification(message, type = 'info') {
    // Créer l'élément de notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Styles de la notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 500;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Suppression automatique après 3 secondes
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}
</script>