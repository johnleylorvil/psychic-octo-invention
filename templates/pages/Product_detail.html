{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Afèpanou{% endblock %}

{% block meta_description %}{{ product.short_description|default:product.description|truncatewords:25 }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="Fil d'Ariane" class="breadcrumb-nav py-3">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'marketplace:home' %}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{% url 'marketplace:categories' %}">Catégories</a></li>
            <li class="breadcrumb-item"><a href="{% url 'marketplace:category' slug=product.category.slug %}">{{ product.category.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name|truncatewords:5 }}</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block extra_css %}
<style>
.product-gallery {
    position: sticky;
    top: 20px;
}

.main-image {
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.thumbnail-image {
    cursor: pointer;
    transition: opacity 0.3s ease;
}

.thumbnail-image:hover {
    opacity: 0.8;
}

.product-info {
    padding-left: 2rem;
}

.price-section {
    background: linear-gradient(135deg, rgba(230, 126, 34, 0.1), rgba(211, 84, 0, 0.05));
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.reviews-section {
    border-top: 1px solid #dee2e6;
    padding-top: 3rem;
    margin-top: 3rem;
}
</style>
{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="container">
        <div class="row">
            <!-- Product Gallery -->
            <div class="col-lg-6">
                <div class="product-gallery">
                    <!-- Main Image -->
                    <div class="main-image-container mb-3">
                        {% if product.main_image %}
                            <img 
                                src="{{ product.main_image.url }}" 
                                alt="{{ product.name }}" 
                                class="img-fluid main-image w-100"
                                id="mainProductImage"
                            >
                        {% else %}
                            <div class="placeholder-main-image d-flex align-items-center justify-content-center" style="height: 400px; background-color: #f8f9fa; border-radius: 12px;">
                                <div class="text-center">
                                    <i class="fas fa-image fa-4x text-muted mb-3" aria-hidden="true"></i>
                                    <p class="text-muted">Image non disponible</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Thumbnail Gallery -->
                    {% if product.images.count > 1 %}
                    <div class="thumbnail-gallery">
                        <div class="row g-2">
                            {% for image in product.images.all %}
                            <div class="col-3">
                                <img 
                                    src="{{ image.image.url }}" 
                                    alt="{{ product.name }}" 
                                    class="img-thumbnail thumbnail-image w-100"
                                    data-main-image="{{ image.image.url }}"
                                    style="height: 80px; object-fit: cover;"
                                >
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Information -->
            <div class="col-lg-6">
                <div class="product-info">
                    <!-- Category -->
                    <div class="product-category mb-2">
                        <a href="{% url 'marketplace:category' slug=product.category.slug %}" class="category-link text-primary">
                            {{ product.category.name }}
                        </a>
                    </div>
                    
                    <!-- Product Name -->
                    <h1 class="product-name h2 mb-3">{{ product.name }}</h1>
                    
                    <!-- Rating and Reviews -->
                    <div class="product-rating mb-4">
                        {% include 'components/rating_stars.html' with rating=product.average_rating reviews_count=reviews.count %}
                    </div>
                    
                    <!-- Price Section -->
                    <div class="price-section">
                        {% if product.promotional_price %}
                            <div class="price-container">
                                <div class="current-price h3 text-primary mb-2">{{ product.promotional_price|floatformat:2 }} HTG</div>
                                <div class="price-details">
                                    <span class="original-price h5 text-muted text-decoration-line-through me-3">{{ product.price|floatformat:2 }} HTG</span>
                                    <span class="discount-badge badge bg-danger">-{{ product.discount_percentage|floatformat:0 }}%</span>
                                </div>
                                <div class="savings mt-2">
                                    <small class="text-success">
                                        <i class="fas fa-tag me-1" aria-hidden="true"></i>
                                        Vous économisez {{ product.savings|floatformat:2 }} HTG
                                    </small>
                                </div>
                            </div>
                        {% else %}
                            <div class="price-container">
                                <div class="current-price h3 text-primary">{{ product.price|floatformat:2 }} HTG</div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Stock Status -->
                    <div class="stock-status mb-4">
                        {% if product.stock_quantity > 0 %}
                            {% if product.stock_quantity <= product.low_stock_threshold %}
                                <div class="alert alert-warning py-2">
                                    <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                                    Stock limité - Plus que {{ product.stock_quantity }} disponible{{ product.stock_quantity|pluralize }}
                                </div>
                            {% else %}
                                <div class="alert alert-success py-2">
                                    <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                                    En stock
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-danger py-2">
                                <i class="fas fa-times-circle me-2" aria-hidden="true"></i>
                                Rupture de stock
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Product Actions -->
                    {% if product.stock_quantity > 0 %}
                    <div class="product-actions mb-4">
                        <form class="add-to-cart-form" data-product-id="{{ product.id }}">
                            {% csrf_token %}
                            
                            <!-- Quantity Selector -->
                            <div class="quantity-section mb-3">
                                <label for="quantity" class="form-label fw-semibold">Quantité:</label>
                                <div class="quantity-controls d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-decrease" aria-label="Diminuer">
                                        <i class="fas fa-minus" aria-hidden="true"></i>
                                    </button>
                                    <input 
                                        type="number" 
                                        class="form-control quantity-input mx-2 text-center" 
                                        id="quantity" 
                                        name="quantity" 
                                        value="1" 
                                        min="1" 
                                        max="{{ product.available_quantity }}"
                                        style="max-width: 80px;"
                                    >
                                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-increase" aria-label="Augmenter">
                                        <i class="fas fa-plus" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                {% if user.is_authenticated %}
                                    <button type="submit" class="btn btn-primary btn-lg me-3 btn-add-to-cart">
                                        <i class="fas fa-shopping-cart me-2" aria-hidden="true"></i>
                                        Ajouter au panier
                                    </button>
                                    
                                    <button type="button" class="btn btn-outline-primary btn-lg btn-wishlist" data-product-id="{{ product.id }}">
                                        <i class="far fa-heart me-2" aria-hidden="true"></i>
                                        Favoris
                                    </button>
                                {% else %}
                                    <a href="{% url 'account:login' %}?next={{ request.path }}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-shopping-cart me-2" aria-hidden="true"></i>
                                        Se connecter pour acheter
                                    </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    {% endif %}
                    
                    <!-- Seller Information -->
                    <div class="seller-section mb-4 p-3 border rounded">
                        <h6 class="seller-title mb-3">Vendeur</h6>
                        <div class="seller-info d-flex align-items-center">
                            <div class="seller-avatar me-3">
                                {% if product.user.profile_image %}
                                    <img src="{{ product.user.profile_image.url }}" alt="Vendeur" class="rounded-circle" width="48" height="48">
                                {% else %}
                                    <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background-color: #f8f9fa;">
                                        <i class="fas fa-user text-muted" aria-hidden="true"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="seller-details">
                                <div class="seller-name fw-semibold">
                                    <a href="{% url 'marketplace:seller_profile' username=product.user.username %}" class="text-decoration-none">
                                        {{ product.user.get_full_name|default:product.user.username }}
                                    </a>
                                </div>
                                {% if product.user.vendor_profile %}
                                    <div class="seller-rating">
                                        {% include 'components/rating_stars.html' with rating=product.user.vendor_profile.average_rating %}
                                    </div>
                                    <small class="text-muted">
                                        {{ product.user.vendor_profile.total_orders }} commande{{ product.user.vendor_profile.total_orders|pluralize }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="seller-actions mt-3">
                            <a href="{% url 'marketplace:seller_profile' username=product.user.username %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-store me-1" aria-hidden="true"></i>
                                Voir la boutique
                            </a>
                        </div>
                    </div>
                    
                    <!-- Product Features -->
                    <div class="product-features mb-4">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-truck text-primary me-2" aria-hidden="true"></i>
                                Livraison disponible
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-shield-alt text-primary me-2" aria-hidden="true"></i>
                                Paiement sécurisé avec MonCash
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-undo text-primary me-2" aria-hidden="true"></i>
                                Retour sous 7 jours
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Details Tabs -->
        <div class="product-details-tabs mt-5">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">
                        Description
                    </button>
                </li>
                {% if product.specifications %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications" type="button" role="tab">
                        Spécifications
                    </button>
                </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                        Avis ({{ reviews.count }})
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="productTabsContent">
                <!-- Description Tab -->
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div class="p-4">
                        {% if product.description %}
                            <div class="product-description">
                                {{ product.description|linebreaks }}
                            </div>
                        {% else %}
                            <p class="text-muted">Aucune description détaillée disponible.</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Specifications Tab -->
                {% if product.specifications %}
                <div class="tab-pane fade" id="specifications" role="tabpanel">
                    <div class="p-4">
                        <div class="specifications-list">
                            {% for key, value in product.specifications.items %}
                            <div class="row py-2 border-bottom">
                                <div class="col-md-4 fw-semibold">{{ key }}</div>
                                <div class="col-md-8">{{ value }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="p-4">
                        <!-- Review Form -->
                        {% if can_review %}
                        <div class="review-form-section mb-5">
                            <h5>Laisser un avis</h5>
                            <form method="post" class="review-form">
                                {% csrf_token %}
                                {{ review_form.as_p }}
                                <button type="submit" class="btn btn-primary">Publier l'avis</button>
                            </form>
                        </div>
                        {% endif %}
                        
                        <!-- Reviews List -->
                        <div class="reviews-list">
                            {% for review in reviews %}
                            <div class="review-item border-bottom pb-4 mb-4">
                                <div class="review-header d-flex justify-content-between align-items-start mb-2">
                                    <div class="reviewer-info">
                                        <h6 class="reviewer-name mb-1">{{ review.user.get_full_name|default:review.user.username }}</h6>
                                        {% include 'components/rating_stars.html' with rating=review.rating %}
                                    </div>
                                    <small class="text-muted">{{ review.created_at|date:"d F Y" }}</small>
                                </div>
                                
                                {% if review.title %}
                                <h6 class="review-title">{{ review.title }}</h6>
                                {% endif %}
                                
                                <p class="review-comment">{{ review.comment|linebreaks }}</p>
                                
                                {% if review.helpful_count %}
                                <div class="review-helpful">
                                    <small class="text-muted">
                                        {{ review.helpful_count }} personne{{ review.helpful_count|pluralize }} 
                                        {{ review.helpful_count|pluralize:"a,ont" }} trouvé cet avis utile
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            {% empty %}
                            <div class="no-reviews text-center py-5">
                                <i class="fas fa-comments fa-3x text-muted mb-3" aria-hidden="true"></i>
                                <h5>Aucun avis pour l'instant</h5>
                                <p class="text-muted">Soyez le premier à laisser un avis sur ce produit.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Related Products -->
        {% if related_products %}
        <section class="related-products mt-5">
            <h3 class="section-title mb-4">Produits similaires</h3>
            <div class="row g-4">
                {% for product in related_products %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                    {% include 'components/product_card.html' %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image gallery functionality
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    const mainImage = document.getElementById('mainProductImage');
    
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const newSrc = this.dataset.mainImage;
            if (mainImage && newSrc) {
                mainImage.src = newSrc;
            }
        });
    });
    
    // Quantity controls
    const quantityInput = document.querySelector('.quantity-input');
    const decreaseBtn = document.querySelector('.quantity-decrease');
    const increaseBtn = document.querySelector('.quantity-increase');
    
    if (decreaseBtn) {
        decreaseBtn.addEventListener('click', function() {
            const current = parseInt(quantityInput.value);
            if (current > 1) {
                quantityInput.value = current - 1;
            }
        });
    }
    
    if (increaseBtn) {
        increaseBtn.addEventListener('click', function() {
            const current = parseInt(quantityInput.value);
            const max = parseInt(quantityInput.max);
            if (current < max) {
                quantityInput.value = current + 1;
            }
        });
    }
});
</script>
{% endblock %}