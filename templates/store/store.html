<!-- templates/store/store.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} - Afèpanou Marketplace{% endblock %}
{% block description %}Découvrez les meilleurs produits de la catégorie {{ category.name }} sur Afèpanou. Soutenez l'entrepreneuriat haïtien.{% endblock %}
{% block og_title %}{{ category.name }} - Afèpanou Marketplace{% endblock %}
{% block og_description %}Explorez les produits de {{ category.name }} et soutenez l'économie locale haïtienne.{% endblock %}
{% block twitter_title %}{{ category.name }} - Afèpanou Marketplace{% endblock %}

{% block content %}
<div class="store-container bg-soft min-h-screen">
    <!-- Hero Section (optionnelle, peut reprendre le style de home.css) -->
    <section class="hero bg-gradient-to-r from-primary to-secondary text-white py-20 text-center">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 font-accent">{{ category.name }}</h1>
            <p class="text-xl md:text-2xl max-w-3xl mx-auto">Découvrez nos produits {{ category.name|lower }}</p>
        </div>
    </section>

    <!-- Breadcrumbs -->
    <nav class="breadcrumb-section bg-soft py-4" aria-label="Fil d'Ariane">
        <div class="container mx-auto px-4">
            <ol class="flex items-center text-sm text-light">
                <li><a href="{% url 'core:home' %}" class="hover:text-primary transition">Accueil</a></li>
                <li class="mx-2">/</li>
                <li class="text-dark font-medium" aria-current="page">{{ category.name }}</li>
            </ol>
        </div>
    </nav>

    <!-- Main Store Content -->
    <div class="container mx-auto px-4 py-12">
        <!-- Section Titre & Filtres (simplifiés pour l'instant) -->
        <section class="store-header mb-12 text-center">
            <h2 class="text-3xl font-bold text-dark mb-4">{{ category.name }}</h2>
            <p class="text-light max-w-2xl mx-auto">Trouvez les meilleurs produits de cette catégorie sur Afèpanou.</p>
            <!-- Filtres et tri pourraient aller ici -->
        </section>

        <!-- Products Grid -->
        <section class="products-section">
            {% if products %}
            <div class="products-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                {% for product in products %}
                <div class="product-card bg-white rounded-2xl overflow-hidden shadow-soft transition duration-300 ease-in-out transform hover:-translate-y-2 hover:shadow-lg hover:translate-x-1 relative">
                    <!-- Image -->
                    <div class="product-image h-64 bg-beige flex items-center justify-center overflow-hidden relative">
                        {% if product.images.exists %}
                            <!-- MISE À JOUR : Utilisation de image_url au lieu de image.url -->
                            <img src="{{ product.images.first.image_url }}" alt="{{ product.name }}" class="w-full h-full object-contain transition-transform duration-500">
                        {% else %}
                            <div class="text-muted text-5xl">
                                <i class="fas fa-image"></i>
                            </div>
                        {% endif %}
                        <!-- Badge Nouveau (optionnel) -->
                        {% if product.is_new %}
                        <span class="absolute top-4 left-4 bg-accent text-white text-xs font-bold px-3 py-1 rounded-full z-10">Nouveau</span>
                        {% endif %}
                        <!-- Badge Réduction (optionnel) -->
                        {% if product.discount_percent > 0 %}
                        <span class="absolute top-4 right-4 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full z-10">-{{ product.discount_percent }}%</span>
                        {% endif %}
                    </div>

                    <!-- Product Info -->
                    <div class="product-info p-6">
                        <h3 class="product-title text-xl font-semibold text-dark mb-2 line-clamp-2">{{ product.name }}</h3>
                        <p class="product-description text-light text-sm mb-4 line-clamp-2">{{ product.description|truncatewords:15 }}</p>

                        <div class="product-meta flex justify-between items-center mb-4">
                            <!-- MISE À JOUR : Utilisation de stock_quantity au lieu de stock -->
                            {% if product.stock_quantity > 0 %}
                            <span class="product-stock text-forest text-sm flex items-center">
                                <i class="fas fa-check-circle mr-1"></i> En stock ({{ product.stock_quantity }})
                            </span>
                            {% else %}
                            <span class="product-stock text-red-500 text-sm flex items-center">
                                <i class="fas fa-times-circle mr-1"></i> Épuisé
                            </span>
                            {% endif %}
                            <div class="product-rating">
                                <div class="stars flex text-yellow-400">
                                    <!-- Exemple de notation fixe, à dynamiser avec product.average_rating -->
                                    <i class="fas fa-star filled"></i>
                                    <i class="fas fa-star filled"></i>
                                    <i class="fas fa-star filled"></i>
                                    <i class="fas fa-star filled"></i>
                                    <i class="fas fa-star-half-alt filled"></i>
                                    <!-- <i class="fas fa-star"></i> -->
                                </div>
                                <!-- <span class="rating-text text-xs text-light ml-1">(4.5)</span> -->
                            </div>
                        </div>

                        <div class="product-footer flex justify-between items-center">
                            <span class="product-price text-primary font-bold text-lg">{{ product.price }} HTG</span>
                            {% if product.stock_quantity > 0 %}
                            <button class="add-to-cart-btn btn btn-primary text-sm px-4 py-2 flex items-center"
                                    data-product-id="{{ product.id }}">
                                <i class="fas fa-shopping-cart mr-2"></i> Ajouter
                            </button>
                            {% else %}
                             <button class="btn btn-outline text-sm px-4 py-2 opacity-50 cursor-not-allowed" disabled>
                                <i class="fas fa-shopping-cart mr-2"></i> Épuisé
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Lien vers les détails (optionnel, le clic sur la carte pourrait aussi mener aux détails) -->
                    <a href="{% url 'store:store_view' store_name %}?product_id={{ product.id }}" class="absolute inset-0 z-10" aria-label="Voir les détails de {{ product.name }}"></a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-20">
                <h3 class="text-2xl font-semibold text-dark mb-4">Aucun produit trouvé</h3>
                <p class="text-light mb-6">Il n'y a actuellement aucun produit dans cette catégorie.</p>
                <a href="{% url 'core:home' %}" class="btn btn-primary">Retour à l'accueil</a>
            </div>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Styles spécifiques à la page du store si nécessaire */
.store-container {
    margin-top: var(--header-height, 80px); /* Compenser la hauteur du header fixe */
}

.product-image {
    height: 200px; /* Ajuster la hauteur selon les besoins */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: var(--warm-beige); /* Couleur de fond si pas d'image */
}
.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Couvrir la zone sans déformation */
    transition: transform var(--transition-base);
}
.product-card:hover .product-image img {
    transform: scale(1.05);
}

/* S'assurer que la grille s'adapte bien */
.products-grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Utiliser auto-fill pour remplir l'espace */
    gap: var(--space-8);
}

/* Styles pour la pagination */
.pagination-container {
    margin-top: var(--space-12);
}
.pagination-link {
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
}
.pagination-link:hover {
    background-color: var(--warm-beige);
}

/* Responsive */
@media (max-width: 768px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--space-6);
    }
}
@media (max-width: 480px) {
    .products-grid {
        grid-template-columns: 1fr; /* Une colonne sur très petit écran */
    }
    .product-footer {
        flex-direction: column;
        gap: var(--space-2);
    }
    .product-footer .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du clic sur le bouton "Ajouter au Panier"
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const quantity = 1; // Quantité par défaut, pourrait être dynamique

            // Animation ou feedback visuel (optionnel)
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout...';
            this.disabled = true;

            // Appel AJAX vers l'API Django (StoreView)
            fetch(window.location.pathname, { // Utilise l'URL actuelle du store
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value // Important !
                },
                body: new URLSearchParams({
                    'action': 'add_to_cart',
                    'product_id': productId,
                    'quantity': quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur:', data.error);
                    alert('Erreur lors de l\'ajout au panier: ' + data.error);
                    // Rétablir le bouton
                    this.innerHTML = originalText;
                    this.disabled = false;
                } else {
                    // Mise à jour du badge du panier dans le header
                    const cartBadge = document.getElementById('cart-badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.total_items; // Utiliser total_items du JSON renvoyé
                        // Ajouter une animation ou un effet visuel si souhaité
                        cartBadge.classList.add('animate-pulse'); // Exemple, nécessite une animation CSS
                        setTimeout(() => cartBadge.classList.remove('animate-pulse'), 1000);
                    }
                    // Feedback à l'utilisateur
                    alert(`"${data.items.find(item => item.product_id == productId).name}" ajouté au panier!`);
                    // Rétablir le bouton
                    this.innerHTML = '<i class="fas fa-check"></i> Ajouté';
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Erreur réseau:', error);
                alert('Erreur de connexion. Veuillez réessayer.');
                // Rétablir le bouton
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}